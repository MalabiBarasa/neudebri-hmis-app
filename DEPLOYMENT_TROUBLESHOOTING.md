# Deployment Troubleshooting Guide

## Issue: "relation 'auth_user' does not exist" Error

This is the most common error on Render deployments. It means **database migrations haven't run yet**.

### Root Causes & Solutions

#### 1. **Startup Migrations Haven't Completed** (Most Common)
**Symptom**: Error appears immediately on first deploy or after rebuild
**Cause**: PostgreSQL initialization or migration process is slow
**Solution**:
- Wait 2-3 minutes for Render to fully initialize the database and run migrations
- Check Render logs for startup progress:
  - Go to Render Dashboard ‚Üí Your Service ‚Üí Logs
  - Look for messages like: `[timestamp] üîç Checking database connectivity...`
  - Should see: `‚úì Database connection successful` and `‚úì Migrations completed successfully`

#### 2. **PostgreSQL Database Not Ready**
**Symptom**: "FATAL: the database system is initializing..."
**Cause**: PostgreSQL taking time to initialize on first deploy
**Solution**:
- This is expected on first deployment - PostgreSQL free tier takes 30-60 seconds
- Wait for logs to show: `‚úì Database connection successful`
- After retry succeeds, delete app from Render and redeploy if needed

#### 3. **DATABASE_URL Environment Variable Not Set**
**Symptom**: Migrations run but use SQLite instead of PostgreSQL
**Cause**: Environment variable not properly linked from database instance
**Solution**:
- In Render Dashboard, verify the database is **attached to the service**
- Check Settings ‚Üí Environment Variables - `DATABASE_URL` should appear
- If missing: Detach database, then reattach it from the "Internal Database URL" option

#### 4. **render_startup.sh Not Executable**
**Symptom**: "bash: ./render_startup.sh: Permission denied"
**Cause**: Git doesn't preserve executable permissions
**Solution**:
- Update `render.yaml` `startCommand` to:
  ```yaml
  startCommand: bash -c "python manage.py startup_migrations && exec gunicorn ..."
  ```
  Or explicitly run Python instead of bash script

#### 5. **Network Connectivity Issues**
**Symptom**: "connection refused" or timeout errors
**Cause**: Render's network policies or PostgreSQL connection limits
**Solution**:
- Verify PostgreSQL is in the same Render account/region
- Check database max connections (free tier is limited to 20)
- Check Render service region matches database region

---

## Verification Checklist

‚úì **Is the app deployed?**
- Visit: `https://neudebri-hmis-app.onrender.com`
- Should show login page (not error)

‚úì **Are logs showing successful migration?**
- Render Dashboard ‚Üí Logs
- Search for: `‚úì Migrations completed successfully`

‚úì **Can you login?**
- Username: `admin`
- Password: `admin1234`
- Should redirect to dashboard

‚úì **Is the database connected?**
- Settings in error page should show:
  - `DATABASE_URL: postgresql://neudebri_user:...`
  - Engine: `django.db.backends.postgresql`

‚úì **Are static files loading?**
- CSS styling should appear on login page
- Check for 404 errors on `/static/` files in console

---

## How to Trigger Migrations Manually

**On Render (No Shell Access):**
- Delete the app and recreate it
- Or make a code change and push to GitHub ‚Üí auto-redeploy

**For Testing Locally:**
```bash
# Install dependencies
pip install -r requirements.txt

# Set production environment
export DATABASE_URL="postgresql://user:pass@host/dbname"

# Run migrations
python manage.py migrate

# Create test users
python manage.py startup_migrations
```

---

## Render Deployment Checklist

When deploying to Render:

1. **Create PostgreSQL Database**
   - Render Dashboard ‚Üí Create New ‚Üí PostgreSQL
   - Free tier is sufficient for testing
   - Copy connection details

2. **Create Web Service**
   - Render Dashboard ‚Üí Create New ‚Üí Web Service
   - Connect your GitHub repo
   - Runtime: Python 3
   - Build Command: `pip install -r requirements.txt && python manage.py collectstatic --noinput`
   - Start Command: `bash render_startup.sh`

3. **Attach Database**
   - Environment Variables section
   - Render should auto-link PostgreSQL as `DATABASE_URL`
   - Verify it appears in dashboard

4. **Environment Variables**
   These should be auto-set or configured:
   - `DEBUG`: `False`
   - `SECRET_KEY`: Auto-generated by Render
   - `ALLOWED_HOSTS`: Should include your service URL
   - `DATABASE_URL`: Auto-linked from PostgreSQL

5. **Deploy**
   - Push code to GitHub main branch
   - Render auto-deploys
   - Monitor logs: `https://dashboard.render.com`

---

## Understanding Startup Sequence

The professional startup process follows this order:

```
1. Render starts container with PORT=10000
2. render_startup.sh executes
3. ‚îú‚îÄ Runs: python manage.py startup_migrations
4. ‚îÇ ‚îú‚îÄ Checks if DATABASE_URL exists (production detection)
5. ‚îÇ ‚îú‚îÄ Tests database connectivity (with 5 retries)
6. ‚îÇ ‚îú‚îÄ Runs: python manage.py migrate --noinput
7. ‚îÇ ‚îÇ  ‚îî‚îÄ Creates all database tables (auth_user, auth_group, etc.)
8. ‚îÇ ‚îú‚îÄ Creates admin user (admin/admin1234)
9. ‚îÇ ‚îî‚îÄ Creates 8 staff test users
10. ‚îú‚îÄ Gunicorn starts on port 10000
11. ‚îî‚îÄ App ready to handle requests
```

Each step logs with timestamps for troubleshooting.

---

## Reading Render Logs

**Render Logs Location**: Dashboard ‚Üí Your Service ‚Üí Logs

**Look for these indicators of success:**
```
[2025-01-28 21:05:00] ==================================================
[2025-01-28 21:05:00] DJANGO HMIS STARTUP MIGRATIONS
[2025-01-28 21:05:00] Environment: PRODUCTION
[2025-01-28 21:05:02] üîç Checking database connectivity...
[2025-01-28 21:05:03] ‚úì Database connection successful (attempt 1)
[2025-01-28 21:05:04] ‚ñ∂ Running database migrations...
[2025-01-28 21:05:10] ‚úì Migrations completed successfully
[2025-01-28 21:05:11] ‚ñ∂ Loading initial data...
[2025-01-28 21:05:12] ‚úì Created admin user (admin/admin1234)
[2025-01-28 21:05:12] ‚úì Initial data loaded (8 new staff users created)
[2025-01-28 21:05:12] ==================================================
[2025-01-28 21:05:12] ‚úì STARTUP COMPLETE - App ready to serve requests
[2025-01-28 21:05:12] ==================================================
[2025-01-28 21:05:13] ‚ñ∂ Step 2: Starting gunicorn WSGI server...
[2025-01-28 21:05:14] [YYYY-MM-DD HH:MM:SS +0000] [1] [INFO] Starting gunicorn...
[2025-01-28 21:05:15] [YYYY-MM-DD HH:MM:SS +0000] [1] [INFO] Listening at: 0.0.0.0:10000
```

**If you see this error:**
```
‚úó FATAL: Cannot connect to database - aborting startup
‚úó FATAL: Migrations failed - aborting startup
```
‚Üí Wait 1-2 minutes and refresh page. PostgreSQL is still initializing.

---

## Common Questions

**Q: Why does my deployment work locally but fail on Render?**
A: Local uses SQLite, Render uses PostgreSQL. The migrations must run against PostgreSQL.

**Q: Can I manually run migrations on Render?**
A: No - Render free tier doesn't provide shell access. Migrations must run automatically on startup.

**Q: What if migrations fail due to database constraints?**
A: Clear the database and redeploy. Or manually delete the app from Render and create a new one.

**Q: How long does initial deployment take?**
A: First deployment: 2-3 minutes (PostgreSQL initialization + migrations)
   Subsequent deploys: 30-60 seconds

**Q: Can I see database contents on Render?**
A: No direct access on free tier, but you can:
   - Test via login (admin/admin1234)
   - Check Django admin (if configured)
   - Review Render logs for errors

---

## Emergency Fixes

**If app keeps showing database errors:**

1. **Option A: Reset Everything**
   - Render Dashboard ‚Üí Your Service ‚Üí Settings ‚Üí Delete Service
   - Delete database instance too
   - Create new service + new database
   - Push code to GitHub
   - Render auto-deploys fresh

2. **Option B: Force Redeploy**
   - Make a small code change (add comment)
   - Commit and push to GitHub
   - Render auto-redeploys
   - Sometimes fixes transient database issues

3. **Option C: Check Database Connection**
   - Render Dashboard ‚Üí Database ‚Üí Copy internal connection URL
   - In your service settings, verify DATABASE_URL env var is set
   - If not set or incorrect, manually update it

---

## Next Steps

1. **Check Render Logs** for startup progress
2. **Wait 2-3 minutes** for first deployment to complete
3. **Try login** with `admin` / `admin1234`
4. **If still failing**: Enable error page details (check DEBUG setting)
5. **Contact support** with log excerpts if persistent issues

---

Generated: 2025-01-28
Last Updated: After professional startup migration improvements
